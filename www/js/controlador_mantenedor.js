function getRegister(){$.ajax({async:!1,url:"../call_ajax.php",data:{clientId:clientId,nameFunction:"getRegisterMaintaince"},type:"POST",success:function(e){BuildDataTable(e)},error:function(e){}})}function actionSend(){var e=null,t=null;$("#containerMessage").remove();var a=$('<div id="containerMessage" class="form-dialog" style="display:none;"><span id="menssageAlertForm" ><div>');$("#inputSave").prepend(a),1==validateForm()?(value=buildArrayValues(),data=JSON.stringify(value),$.ajax({async:!1,url:"../call_ajax.php",type:"POST",data:{data:data,nameFunction:"queryEvent"},success:function(a){"error-duplicate"==a.status?(e="Error: Ya existe un evento de mantenimiento asociado al objetivo "+a.nameObj+" para el periodo indicado, favor de revisar datos.",t="error"):"success"==a.status?(e="Datos ingresados correctamente.",t="success"):"error-nodo"==a.status?(e="El objetivo "+a.nameObj+" no tiene monitor asignado.",t="error"):(e="Ha ocurrido un error en el procesamiento de los datos.",t="error"),displayMessageForm(t,e),setTimeout(function(){$("#dialog-message").dialog("close")},3e3)},error:function(t){displayMessageForm("error",e="Ocurrio un error al procesar los datos.")}})):displayMessageForm("error",e="Por favor revise campos en rojo antes de guardar.")}function displayMessageForm(e,t){"success"==e?(setMessage($("#menssageAlertForm"),t),displayMessage($("#containerMessage"),"block",!0),setColor($("#containerMessage"),"#D0F5A9"),setCss("#containerMessage",null,{color:"#468847","background-color":"dff0d8","border-color":"#d6e9c"},!0)):(setMessage($("#menssageAlertForm"),t),displayMessage($("#containerMessage"),"block",!0),setColor($("#containerMessage"),"#F5A9A9"),setCss("#containerMessage",null,{color:"#b94a48","background-color":"f2dede","border-color":"#ebccd1"},!0))}function getObjetive(){return $.ajax({async:!1,url:"../call_ajax.php",data:{nameFunction:"getObjetive"},type:"POST",success:function(e){saveData(e)},error:function(e){}})}function getObjetiveid(e){var t;return $.ajax({async:!1,url:"../call_ajax.php",data:{ids:e,nameFunction:"getObjetiveId"},type:"POST",success:function(e){t=e},error:function(e){}}),t}function showEvent(e){var t=(e=(e=e.replace("{"," ")).replace("}"," ").trim()).split(","),a=!1;return $.each(OBJETIVES,function(e,n){"-1"!=jQuery.inArray(n.objetivo_id,t)&&(a=!0)}),a}function BuildDataTable(e){var t=parseInt($("#usuario_cliente_id").val());countDataTableInit+=1,allRegister=JSON.parse(e),$("#register").empty(),$("#example").DataTable().fnClearTable(this),$("#load_evento").hide(),$.each(allRegister,function(e,a){var n=a.id+"-icon",o=setStatus(a.estado),i=a.fecha_inicio,r=a.fecha_termino;1==showEvent(a.objetivo_id)&&(ids=a.objetivo_id,ids=ids.replace("{",""),ids=ids.replace("}",""),ids='"'+ids+'"',a.usuario_id==t?(element="#"+n,$("#register").append("<tr><td>"+a.id+"</td><td >"+a.nombre+"</td><td >"+i+"</td><td>"+r+"</td><td >"+a.titulo+"</td><td >"+o+"</td><td> <a href='#' onclick='getObjetivos("+ids+");' >Ver todos</a></td><td ><a href='#' onclick='editMaintance("+JSON.stringify(a)+","+ids+");' ><i class='spriteButton spriteButton-editar' id= "+n+" border='0' title='editar'></i></a></td></tr>"),$(element).hover(function(){setCss(this,"zoom","1.5",!1)},function(){try{setCss(this,"zoom","",!1)}catch(e){}})):$("#register").append("<tr><td>"+a.id+"</td><td >"+a.nombre+"</td><td >"+i+"</td><td>"+r+"</td><td >"+a.titulo+"</td><td >"+o+"</td><td><a href='#' onclick='getObjetivos("+ids+");' >Ver todos</a></td><td ></td></tr>"))}),countDataTableInit>1?($("#example").DataTable().fnDestroy(),$("#example").dataTable({sPaginationType:"full_numbers",aaSorting:[[0,"desc"]],scrollY:"280px",scrollCollapse:!0,bDestroy:!0})):$("#example").dataTable({sPaginationType:"full_numbers",aaSorting:[[0,"desc"]],scrollY:"280px",scrollCollapse:!0,bDestroy:!0}),setCss("#example","display","inline",!1),setCss("#example","width","100%",!1),setHover([".odd",".even"]),"0"==eventId&&0==eventId||null!=statusEvent||(setTimeout(function(){try{$(".inputB").val(eventId).trigger("keyup"),document.getElementById(eventId+"-icon").click()}catch(e){alert("No puede editar el evento Id: "+eventId)}},800),statusEvent=!0,$("#evento_id").val("0"))}function setHover(){$.each(arguments[0],function(e,t){$(t).hover(function(){setCss(this,"opacity",".7",!1)},function(){setCss(this,"opacity","1",!1)})})}function editMaintance(e,t){startData=e.fecha_inicio.split(" "),endData=e.fecha_termino.split(" "),id=startData[0],dateFull={startD:startData[0],startH:startData[1],endD:endData[0],endH:endData[1]},cleanForm(),buildSelect(OBJETIVES,t),displayMessage($("#containerMessage"),"none",!0),buildInfoForm(e),$(document).ready(function(){$("#dialog-message").dialog({width:"715px",heigth:"600px",dialogClass:"ui-dialog-osx",resizable:!1,modal:!0}),$("#dialog-message").dialog("option","resizable",!1)}),$(".icon").hover(function(){setCss(this,"zoom","document",!1)},function(){try{setCss(this,"zoom","",!1)}catch(e){}})}function dialogCalendar(){displayMessage($("#containerMessage"),"none",!0),loadCalendar(),$(document).ready(function(){$("#dialog-calendario").dialog({width:"800px ",dialogClass:"ui-dialog-osx",modal:!0,close:function(e,t){}})}),setCss(".ui-dialog-titlebar",{"background-color":"#f47001",color:"#fff"},!0),setCss(".ui-dialog-title",{"background-color":"#f47001",color:"#fff",float:"none"},!0)}function setCss(e,t,a,n){1==n?$(e).css(a):$(e).css(t,a)}function changeColor(e,t){e.style.borderColor=t}function hiddenSlow(e){$(e).fadeOut(4e3)}function displayMessage(e,t,a){e.css("display",t),1==a&&hiddenSlow(e.selector)}function setMessage(e,t){e.html(t)}function setColor(e,t){e.css("background-color",t)}function cleanForm(){setCss(".inputMaintainer","border-color","#b3b3b3",!1),setCss(".selectMaintainer","border-color","#b3b3b3",!1),controllerRemoveClass(".dia","seleccionado")}function controllerRemoveClass(e,t){$(e).removeClass(t)}function translateDate(e){return moment().format(),localTime=moment(e),localTime.tz(timeZone).format("YYYY-MM-DD HH:mm:ss")}function asignZero(e){return 1==e.length?e="0"+e:e}function setStatus(e){return e}function buildInfoForm(e){var t=null;"Cancelado"==e.estado?($(input[3]).prop("disabled","disabled"),$(input[8]).prop("disabled","disabled"),$(input[9]).prop("disabled","disabled"),$("#guardar").hide(),t=2):($(input[3]).removeAttr("disabled"),$(input[8]).removeAttr("disabled"),$(input[9]).removeAttr("disabled"),$("#guardar").show(),t=1),$(input[0]).val(e.id),$(input[1]).val(e.nombre),$(input[2]).val(e.usuario_id),$(input[3]).val(t),$(input[4]).val(e.fecha_inicio),$(input[5]).val(e.fecha_termino),$(input[6]).val(e.fecha_creacion),$(input[7]).val(e.fecha_modificacion),$(input[8]).val(e.titulo),$(input[9]).val(e.comentario),retryInsert="Error"==e.estado}function validateForm(){var e=document.getElementById("estado"),t=document.getElementById("fechaI"),a=document.getElementById("fechaT"),n=!0,o=/^[0-9][0-9][0-9][0-9]-([0-9]|0[0-9]|1[0-2])-([0-9]|0[0-9]|1[0-9]|2[0-9]|3[0-1]) ([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;return 0!=e.value.search(/^[1-2]$/)?(n=!1,changeColor(e,"red")):changeColor(e,"green"),0!=t.value.search(o)?(n=!1,changeColor(dateStart,"red")):changeColor(t,"green"),0!=a.value.search(o)?(n=!1,changeColor(a,"red")):changeColor(a,"green"),startDateFormat=moment(t.value),endDateFormat=moment(a.value),$("#startDate").html("startDate: "+startDateFormat.format()),$("#endDate").html("endDate: "+endDateFormat.format()),endDateFormat.diff(startDateFormat,"hours",!0)<=0?(n=!1,changeColor(t,"red")):changeColor(t,"green"),n}function buildArrayValues(){var e=new Array,t="";getValueMultiSelect();return $.each(input,function(t,a){e[t]=$(a).val()}),$("#objetive :selected").each(function(e,a){t=t+$(a).text()+","}),e[10]="",e[11]="Editar",e[12]=timeZone,e[13]=t,e[14]=retryInsert,e}function getValueMultiSelect(){var e=0,t="{";return $(".ui-multiselect .selected li").each(function(a,n){var o=$(n).data("optionLink");o&&(1==e?t+=o.val():t=t+","+o.val()),e++}),t+="}"}function loadCalendar(){jQuery(function(e){var t=!1,a=(dateFull.startD,dateFull.endD,e("#calendario_especial")),n={},o=e('<input type="hidden" name="fecha_inicio_periodico" id="fecha_inicio_periodico" value="">'),i=e('<input type="hidden" name="fecha_termino_periodico" id="fecha_termino_periodico" value="">'),r=e('<button class="btn" type="button" name="guardarFecha" id="guardarFecha" value="Definir" onclick="setInputDate();">Definir</button>'),s=e('<div id="containerMessage" class="form-dialog" style="display:none;"><span id="menssageAlert" ><div>'),l=e("<br/>");e("#containerMessage").remove(),e("#fecha_inicio_periodico").remove(),e("#fecha_termino_periodico").remove(),e("#guardarFecha").remove(),e("#hourStartInput").remove(),e("#hourEndInput").remove(),"".length>0&&(n.fechaCalendario="00:00:00"),"".length>0&&(n.fechaMinima="00:00:00"),n.especial=!0,n.fechaInicio=dateFull.startD+" 12:00:00",n.fechaTermino=dateFull.endD+" 12:00:00",n.seleccion={},n.seleccion.activa=!0,n.seleccion.intervalo=!0,a.calendariou(n);var d=a.data("calendariou");a.append(o,i),buildInputHour(t),d.seleccion.el().on("calendariou:seleccion:cambio",function(){var e=d.seleccion.get("fechaInicio"),a=d.seleccion.get("fechaTermino");t=!0,o.prop("value",null===e?null:e.format("yyyy-mm-dd")),i.prop("value",null===a?null:subtractOneDay(a.format("yyyy-mm-dd"))),buildInputHour(t)}),a.append(s),a.append(l),a.append(r)})}function subtractOneDay(e){return day=e.substr(8,9),day=String(parseInt(day)-1),1==day.length&&(day="0"+day),e.replaceAt(8,day)}function setInputDate(){dateStart=$("#fecha_inicio_periodico").val(),dateEnd=$("#fecha_termino_periodico").val(),returnVal=validateAfterSet(),1==returnVal[0]?($("#dialog-calendario").dialog("close"),displayMessage($("#containerMessage"),"none",!0),fechaInicio=$("#fecha_inicio_periodico").val()+" "+$("#hourStartInput").val(),fechaTermino=$("#fecha_termino_periodico").val()+" "+$("#hourEndInput").val(),$("#fechaI").val(fechaInicio),$("#fechaT").val(fechaTermino)):(1==returnVal[1]?setMessage($("#menssageAlert"),"Formato de hora incorrecto."):setMessage($("#menssageAlert"),"Debe seleccionar un rango de fecha y hora."),displayMessage($("#containerMessage"),"block",!0))}function validateAfterSet(){return hourStart=$("#hI"),hourEnd=$("#hT"),"rgb(255, 0, 0)"==$("#hourStartInput").css("border-color")||"rgb(255, 0, 0)"==$("#hourEndInput").css("border-color")?[!1,1]:""==$("#hourStartInput").val()||""==$("#hourEndInput").val()||void 0===$("#hourStartInput").val()||void 0===$("#hourEndInput").val()?[!1,2]:[!0,0]}function buildInputHour(e){$("#hourStartInput").remove(),$("#hourEndInput").remove(),hourStart=$("#hI"),hourEnd=$("#hT"),hourStart.html(""),hourEnd.html(""),hourStart.append($('<input type="text" name="hourStartInput" class="inputMaintainer" id="hourStartInput" value="" placeholder="03:01:30" maxlength="8" onBlur="validateHour(this);"> ')),hourEnd.append($('<input type="text" name="hourEndInput" class="inputMaintainer" id="hourEndInput" value="" placeholder="03:01:30" maxlength="8" onBlur="validateHour(this);" >')),0==e&&($("#hourStartInput").val(dateFull.startH),$("#hourEndInput").val(dateFull.endH))}function validateHour(e){time=e.value,validate="ok",8!=time.length&&(validate="error"),valReg=time.search("^([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$"),0!=valReg&&(validate="error"),"ok"==validate?changeColor(e,"green"):changeColor(e,"red")}function buildSelect(e,t){count+=1;var a=getObjetiveid(t);objetives=JSON.parse(a),$("#objetive").empty(),$("<tr>").attr({id:"trTitleObjetivos"}).appendTo("#objetive"),$("<th>").text("Objetivo id").appendTo("#trTitleObjetivos"),$("<th>").text("Nombre").attr({width:"50%"}).appendTo("#trTitleObjetivos"),$.each(objetives,function(e,t){$("<tr>").attr({id:"trOjetivo_"+t.objetivo_id}).appendTo("#objetive"),$("<td>").text(t.objetivo_id).appendTo("#trOjetivo_"+t.objetivo_id),$("<td>").text(t.nombre).attr({width:"50%"}).appendTo("#trOjetivo_"+t.objetivo_id)})}function saveData(e){OBJETIVES=JSON.parse(e)}function downloadCsv(){json=JSON.stringify(allRegister),$("<form>").attr({type:"hidden",id:"form_event",name:"form_event",action:"descarga_csv_eventos.php",method:"POST",target:"_self"}).appendTo("body"),$("#form_event").hide(),$("<input>").attr({type:"text",id:"data",name:"data",value:json}).appendTo("#form_event"),$("<input>").attr({type:"text",id:"client",name:"client",value:clientName}).appendTo("#form_event"),$("<input>").attr({type:"text",id:"nameUser",name:"nameUser",value:nameUser}).appendTo("#form_event"),$("#form_event").submit()}dateFull=null,$(document).ready(function(){eventId=$("#evento_id").val(),clientId=$("#cliente_id").val(),clientName=$("#nombre_cliente").val(),nameUser=$("#nombre_usuario").val(),statusEvent=null,count=0,countDataTableInit=0,timeZone=$("#zona_horaria").val(),getObjetive(),$("#dialog-message").on("dialogclose",function(e){}),$("#calendario").click(function(){dialogCalendar()}),$("#dialog-message").each(function(){input=$(this).find(":input")}),$("#guardar").click(function(){2==document.getElementById("estado").value?1==window.confirm("¿Está seguro que desea cancelar el mantenimiento? (Esta acción no se puede revertir).")&&(actionSend(),getRegister()):(actionSend(),getRegister())}),$("#close").click(function(){$("#dialog-message").dialog("close")}),$("#descargar_csv").click(function(){downloadCsv()}),setCss("#containerMessage","display","none",!1),jQuery,getRegister(),setCss(".dataTables_length",null,{color:"#616265","font-family":"Verdana,Arial,Helvetica,sans-serif"},!0),setCss(".dataTables_info",null,{color:"#616265","font-family":"Verdana,Arial,Helvetica,sans-serif"},!0)}),String.prototype.replaceAt=function(e,t){return this.substr(0,e)+t},String.prototype.largeStr=function(){return this.length};